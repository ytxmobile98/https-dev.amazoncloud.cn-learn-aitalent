# 模块 3：深入讨论 Amazon SageMaker Autopilot

## 概览

学习目标：

* 描述 Amazon SageMaker Autopilot 的功能。
* 使用 SageMaker Autopilot 启动作业、跟踪其进度以及部署模型。
* 描述支持的数据格式和类型、问题类型、训练模式和算法。
* 解释 SageMaker Autopilot 如何通过 k 折分割执行交叉验证。
* 描述性能报告中可用的模型质量指标。
* 描述 SageMaker Autopilot 如何解决模型可解释性问题。
* 部署具有实时或批量预测的模型。

## SageMaker Autopilot 简介

Amazon SageMaker Autopilot 消除了构建机器学习 (ML, machine learning) 模型过程中的手动工作。您提供表格数据集并选择要预测的目标列，SageMaker Autopilot 便会自动探索不同的解决方案，以找到最佳模型。

* 它自动执行 ML 过程中的关键任务，包括探索数据和选择适用于您的问题类型的算法。
* 它还自动执行准备数据这一任务，以促进模型训练和优化。
* 然后，您可以直接高效地将模型部署到生产环境中，也可以对推荐的解决方案进行迭代，从而进一步提高模型质量。

![SageMaker Autopilot](<./SageMaker Autopilot.png>)

### SageMaker Data Wrangler 和 SageMaker Autopilot 比选

* 重要区别：
    * 使用 SageMaker Data Wrangler，您可以完全控制特征工程和预处理技术。
    * 而使用 SageMaker Autopilot，整个过程是完全自动化的。
* 使用 SageMaker Data Wrangler 时，您能够在过程中运用您的领域专业知识，这通常是构建优质模型时最重要的要素。一种常见的做法是，在 SageMaker Data Wrangler 中设计特征。然后，您可以使用 SageMaker Autopilot 以底层训练算法所需的方式预处理数据。

### SageMaker Autopilot 的功能

![SageMaker Autopilot 的能力](<./SageMaker Autopilot 的能力.png>)

1. **加载原始数据**：从 Amazon Simple Storage Service (Amazon S3) 加载表格数据来训练模型。
2. **选择目标**：选择要预测的目标列。
3. **自动创建模型**：选择正确的算法，系统将自动为正确的模型进行训练和优化。
4. **获得完全可见性和可控性**：获得模型笔记本的完全可见性。
5. **从模型排行榜中选择**：从排序推荐列表中选择最适合您需求的模型。
6. **部署和监控模型**：直接高效地将模型部署到生产环境。
7. **优化并重新训练模型**：对推荐的解决方案进行迭代，从而进一步提高模型质量。

您可以采用以下方式来使用 SageMaker Autopilot：

* **自动**：探索数据，选择适用于问题类型相关的算法，并准备数据以促进模型训练和优化。
* **手动**：在人工引导下使用 Amazon SageMaker Studio。
* **使用工具**：使用 Amazon SDK。

### 使用 SageMaker Autopilot 的主要步骤

![SageMaker Autopilot中的主要步骤](<./SageMaker Autopilot中的主要步骤.png>)

1. **上传数据集**

    在对数据集运行 SageMaker Autopilot 之前，需要先检查数据集以确保其没有明显错误。SageMaker Autopilot 过程可能需要很长时间，因此最好在启动作业之前检查数据集。对于笔记本实例内存无法容纳的较大数据集，请使用大数据分析工具（例如 Apache Spark）离线检查数据集。

    > SageMaker Autopilot 能够处理最高达 5 GB 的数据集。它会为您预处理数据。您不需要执行传统的数据预处理技术，例如处理缺失值、将分类特征转换为数字特征、扩展数据，以及处理更复杂的数据类型。此外，也没有必要将数据集拆分为训练集和验证集。但是，您可能需要拆分出一个测试集。
2. **设置和启动作业**

    在将数据集上传到 Amazon S3 之后，您可以调用 SageMaker Autopilot 来查找用于基于数据集训练模型的最佳 ML 管道。为此，您需要创建一个试验来启动 SageMaker Autopilot 作业。您可以使用 SageMaker Studio UI 来帮助填充输入、输出、目标和参数。在该 UI 中，您还可以运行和评估试验或使用 SageMaker API 参考。

    在 SageMaker Autopilot 试验中调用作业所需的输入如下：

    * 输入数据集和所有输出构件的 Amazon S3 位置。
    * 要预测的数据集的目标列名称。
    * 训练方法和算法如下：选择集成或超参数优化 (HPO, hyperparameter optimization)。如果您不确定选择哪一个，SageMaker Autopilot 将根据目标列的统计数据推断问题类型。您还可以转到高级设置并选择 ML 问题类型，例如二元分类、回归或多类分类。
    * 部署设置如下：自动机器学习 (AutoML, Automatic machine learning) 会创建一个终端节点，用于部署您的最佳模型并在该终端节点上运行推理。您还可以从一组可用的候选试用模型中进行选择并手动部署。
3. **跟踪作业进度**

    SageMaker Autopilot 作业包含以下主要步骤：

    1. **数据分析**：对数据集进行分析，然后 SageMaker Autopilot 生成应使用数据集进行试验的 ML 管道的列表。数据集还拆分为训练集和验证集。
    2. **特征工程**：SageMaker Autopilot 在数据集的各个特征级别和聚合级别执行特征转换。
    3. **模型优化**：选择性能最佳的管道以及训练算法的最优超参数，这是管道的最后阶段。
4. **部署模型**

    您可以手动部署模型以使用最佳候选项执行批量推理。您也可以使用 SageMaker Autopilot 自动部署模型。

    批量推理，也称为离线推理，使用一批观察值生成模型预测。您在创建试验时选择此选项。

    SageMaker AutoML 在单独的容器中管理数据预处理、模型推理和后处理。为了将这些过程联系在一起，SageMaker Autopilot 使用推理管道机制从候选项创建 SageMaker 模型。
5. **查看其他候选项**

    您可以查看 SageMaker Autopilot 探索的所有候选项，并按它们的最终性能指标对进行排序。

    SageMaker Autopilot 生成两种类型的笔记本：**数据探索**和**候选生成**。它们的定义如下：

    * **数据探索笔记本**：数据探索笔记本提供数据集和分析结果的摘要，例如重复行、列之间的相关性、缺失值和基数。
    * **候选生成笔记本**：最佳模型候选生成笔记本包含数据预处理 (DPP, data preprocessing) 模块。它还包括作为数据探索和搜索超参数范围的结果生成的算法组合。候选生成笔记本还包含有关如何运行和部署优化作业的说明，因此您可以自定义笔记本，然后运行作业，而不是自动执行任务。