# 模块 4：运营最佳实践

## 概览

课程学习目标：

* 实施 Amazon SageMaker Data Wrangler 的以下最佳实践：
    * 更新到最新版本的 SageMaker Data Wrangler
    * 实现成本优化
    * 及早识别不良数据并予以纠正
    * 实施安全最佳实践
* 实施 Amazon SageMaker Autopilot 的以下最佳实践：
    * 实验和数据详细信息
    * 目标和特征
    * 训练方法和算法
    * 部署和高级设置
    * 分组工作

## 环境优化

### 更新到最新版本

要检查是否使用了最新版本的 Amazon SageMaker Data Wrangler，请打开现有的 SageMaker Data Wrangler 流。如果不是最新版本，Amazon SageMaker Studio UI 中会提示您更新 SageMaker Data Wrangler。

## 成本优化

在本节课中，您将学习优化成本的最佳实践。您可以通过使用内置的 SageMaker Data Wrangler 转换、选择最合适的实例类型以及从 SageMaker Studio 笔记本中选择实例，来优化成本。其他最佳实践包括处理更大更广泛的数据集以及关闭未使用的实例。

![成本优化](<./成本优化.png>)

* **使用内置的 SageMaker Data Wrangler 转换**

    在内置的 SageMaker Data Wrangler 转换可用于您的使用案例的情况下，使用这些转换。当您的使用案例无法使用内置转换时，您可以使用 PySpark、Python（用户定义函数）、Python pandas 软件库和 PySpark SQL 来添加自定义转换。
* **选择最合适的实例类型**

    SageMaker Data Wrangler 支持两个机器学习 (ML, machine learning) 实例类型系列：M5 和 R5。M5 实例是通用实例，可实现计算和内存的平衡。R5 实例更适合处理内存中的大型数据集，可以为这些数据集提供较快的性能。

    选择可以优化工作负载的实例。例如，ml.r5.8xlarge 的价格可能高于 ml.m5.4xlarge，但 ml.r5.8xlarge 可能优化程度更高，比较适合您的工作负载。借助优化程度更高的实例，您可以在更短的时间内以更低的成本运行数据流。
* **从 SageMaker Studio 笔记本中选择实例**

    要更改 SageMaker Data Wrangler 工作流的实例类型，请选择1 vCPU + 64 GB 实例配置链接。然后，系统会显示 Select instance（选择实例）窗格。
* **处理更大更广泛的数据集**

    对于大于数十 GB 的数据集，请使用内置转换，或在导入时对数据进行采样，以便用交互方式运行自定义 pandas 转换。
* **关闭未使用的实例**

    您需要为所有正在运行的实例付费。为了避免产生额外费用，请手动关闭不使用的实例。

## 数据优化

![数据优化](<./数据优化.png>)

### 识别并纠正不良数据

如果不能及早识别不良数据并予以纠正，那么以后要解决这个问题就会付出高昂的代价。数据质量和见解报告能帮助消除这个问题。SageMaker Data Wrangler 的最佳实践之一是使用数据质量和见解报告对数据进行分析。该报告可帮助您获取对数据集的见解，例如缺失值的数量和异常值的数量。

《数据质量和见解报告》包含的部分：

* 特征摘要
* 特征的预测能力——表格
* 特征的预测能力——条形图

### 再次使用不同数据集的数据流

对于 Amazon Simple Storage Service (Amazon S3) 数据源，您可以创建和使用参数。参数是保存在 SageMaker Data Wrangler 流中的变量。其值可以是数据源的 Amazon S3 路径的任何部分。使用参数可以快速更改导入到 SageMaker Data Wrangler 流或导出到处理作业的数据。您还可以使用参数来选择和导入数据的特定子集。

创建了 SageMaker Data Wrangler 流之后，可以在转换的数据上训练模型。对于具有相同架构的数据集，您可以使用参数在不同的数据集上应用相同的转换并训练不同的模型。您可以使用新的数据集对模型进行推理，也可以使用它们对模型进行重新训练。

一般而言，参数具有以下属性：

* **名称**：这是您为参数指定的名称。
* **类型**：这是参数表示的值的类型。
* **默认值**：这是在不指定新值时参数的值。

### 使用成本分配标签

导出数据流时，您需要为所使用的亚马逊云科技资源付费。您可以使用成本分配标签来组织和管理这些资源的成本。您为用户配置文件创建这些标签，然后 SageMaker Data Wrangler 会自动对用于导出数据流的资源应用这些标签。

### 使用最合适的可视化

SageMaker 提供的可视化工具：

* **直方图**：查看特定特征的特征值计数。
* **散点图**：检查特征之间的关系。
* **表汇总**：快速汇总数据。
* **快速模型**：快速评估数据并生成每个特征的重要性分数。
* **多重共线性**：是指两个或多个预测变量彼此相关的情况。使用以下分析作为数据中多重共线性的度量：
    * 方差膨胀因子 (VIF, Variance inflation factor)
    * 主成分分析 (PCA, Principal component analysis)
    * Lasso 特征选择
* **异常检测**：查看时间序列数据中的异常值。异常基于将时间序列分解为预测项和误差项。时间序列由两部分组成：季节性和趋势（预测项）和残差值（误差项）。如果误差大于三个标准差，则时间序列中的值将标注为异常。
* **偏差报告**：发现数据中的潜在偏差。
* **自定义可视化**：可向 SageMaker Data Wrangler 流添加分析以创建自定义可视化。您的数据集以及您应用的所有转换都可以作为 `pandas.DataFrame` 使用。

## 安全优化

### 配置限制亚马逊云科技角色的存储桶策略

当查询 Amazon Athena 或 Amazon Redshift 的数据时，查询的数据集会自动存储在默认 Amazon SageMaker S3 存储桶中。该 S3 存储桶位于您使用 SageMaker Studio 的亚马逊云科技区域中。当您从 SageMaker Data Wrangler 导出 Jupyter notebook 时，该 S3 存储桶会将您的 .flow 文件存储在前缀 data_wrangler_flows 下。

### 向 IAM 角色授予权限

此外，您需要向每个使用 SageMaker Data Wrangler 的 IAM 角色授予访问所需资源的权限。您可能需要用于访问 SageMaker Data Wrangler 的 IAM 角色拥有精细权限。如果是这样，您可以将 IAM 托管策略 AmazonSageMakerFullAccess 添加到用于创建 SageMaker Studio 用户的 IAM 角色。此策略授予您使用 SageMaker Data Wrangler 的完全权限。

向 IAM 角色授予权限时的最佳实践：

* 确保具有 SageMaker Audio 所需的权限
* 确保具有 SageMaker Data Wrangler 所需的权限
* 添加存储桶策略
* 创建允许列表
* 使用 Amazon KMS 进行数据加密
* 使用生命周期配置